<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interstellar Comet Passports — B3 (Controllers + Overlay + Zoom)</title>
<style>
  :root{
    --fg:#00ff66; --fg-dim:#00aa55; --bg:#000; --accent:#00cc66;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:var(--mono);overflow:hidden;}
  canvas{display:block}

  /* DOM Overlay root (used both desktop & VR overlay) */
  #overlayRoot{
    position:fixed; inset:0; pointer-events:none;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  /* Top bar: comet buttons centered */
  .topbar{
    display:flex; justify-content:center; align-items:center; gap:.5rem;
    padding:.5rem; pointer-events:auto; user-select:none;
  }
  /* Right-top: zoom + Big Mode */
  .rightTop{
    position:fixed; right:.5rem; top:.5rem; display:flex; gap:.5rem; pointer-events:auto;
  }
  /* Bottom bar: VR button placeholder area */
  .bottombar{
    display:flex; justify-content:center; align-items:center; padding:.4rem .5rem;
    pointer-events:auto;
  }

  .btn{
    background:transparent; color:var(--fg); border:1px solid var(--fg-dim);
    padding:.4rem .6rem; font-family:var(--mono); font-size:.9rem; letter-spacing:.5px;
    cursor:pointer; text-transform:uppercase; transition:transform .08s ease, box-shadow .12s ease;
    box-shadow:0 0 0 rgba(0,0,0,0);
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 8px var(--fg-dim); }
  .btn:active{ transform:translateY(0); }

  .btn.neon{ border-color:var(--accent); box-shadow:0 0 6px #003311 inset, 0 0 10px var(--fg-dim); }

  /* Passport flat panel (DOM) */
  .passport{
    position:fixed; left:50%; transform:translateX(-50%);
    top:64px; width:min(920px, 92vw); pointer-events:none;
    display:grid; grid-template-columns:1fr 1fr; gap:.75rem; padding: .6rem .6rem 1rem;
    border:1px solid var(--fg-dim);
    background:rgba(0,0,0,.35);
    box-shadow:0 0 10px rgba(0,255,102,.18), inset 0 0 20px rgba(0,255,102,.06);
  }
  .passport.big{ transform:translateX(-50%) scale(1.15); transform-origin:top center; }
  .passport h2{ grid-column:1/3; margin:.2rem 0 .4rem 0; font-size:1.15rem; letter-spacing:1px; }
  .field{ border:1px dashed var(--fg-dim); padding:.5rem; min-height:52px; }
  .label{ opacity:.7; font-size:.8rem; margin-bottom:.25rem; }

  .reliability{
    position:fixed; left:0; right:0; bottom:.25rem; text-align:center; font-size:.8rem; opacity:.8;
    pointer-events:none;
    text-shadow:0 0 8px rgba(0,255,102,.25);
  }

  /* Boot-like scanlines for retro */
  .scanlines:before{
    content:""; position:fixed; inset:0; pointer-events:none; background:
      linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,.25) 50%);
    background-size:100% 2px; mix-blend-mode:multiply; opacity:.35;
  }

  /* VRButton gets injected; we restyle via container */
  .vrbtnWrap > .vrButton{
    all:unset;
  }
  .vrbtnWrap button{
    background:transparent; color:var(--fg); border:1px solid var(--accent);
    padding:.5rem .8rem; font-family:var(--mono); text-transform:uppercase;
    cursor:pointer; box-shadow:0 0 10px var(--fg-dim);
  }

  /* Small helper badges */
  .badge{
    border:1px solid var(--fg-dim); padding:.15rem .35rem; font-size:.75rem; opacity:.8;
  }

  /* Ensure overlay always clickable even in VR DOM Overlay */
  #overlayRoot * { pointer-events:auto; }
</style>
</head>
<body>
<div id="overlayRoot" class="scanlines" aria-hidden="false">
  <div class="topbar">
    <button class="btn neon" data-comet="oumuamua">1I / ʻOumuamua</button>
    <button class="btn neon" data-comet="borisov">2I / Borisov</button>
    <button class="btn neon" data-comet="atlas">3I / ATLAS</button>
    <span class="badge" id="modeBadge">MODE: DESKTOP</span>
  </div>

  <div id="passport" class="passport">
    <h2 id="passportTitle">Comet Passport — <span id="currentComet">—</span></h2>
    <div class="field">
      <div class="label">Designation</div>
      <div id="fDesignation">—</div>
    </div>
    <div class="field">
      <div class="label">Discovery</div>
      <div id="fDiscovery">—</div>
    </div>
    <div class="field">
      <div class="label">Origin</div>
      <div id="fOrigin">—</div>
    </div>
    <div class="field">
      <div class="label">Notes</div>
      <div id="fNotes">—</div>
    </div>
  </div>

  <div class="rightTop">
    <button class="btn" id="zoomIn">Zoom +</button>
    <button class="btn" id="zoomOut">Zoom −</button>
    <button class="btn" id="bigMode">Big Mode</button>
  </div>

  <div class="bottombar">
    <div class="vrbtnWrap" id="vrbtnWrap">
      <!-- VRButton injected here -->
    </div>
  </div>
</div>

<div class="reliability">Data reliability: tentative synthesis; controller rays enabled; DOM Overlay active if supported.</div>

<!-- Three.js & controls -->
<script type="module">
  import * as THREE from "https://unpkg.com/three@0.161.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.161.0/examples/jsm/controls/OrbitControls.js";
  import { VRButton } from "https://unpkg.com/three@0.161.0/examples/jsm/webxr/VRButton.js";
  import { XRControllerModelFactory } from "https://unpkg.com/three@0.161.0/examples/jsm/webxr/XRControllerModelFactory.js";

  // === Basic setup
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.75));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x000000, 1);
  renderer.xr.enabled = true;

  // Request DOM Overlay for VR (keeps our HTML buttons visible above 3D)
  const overlayRoot = document.getElementById('overlayRoot');

  // Inject VR button with DOM Overlay feature
  const vrButton = VRButton.createButton(renderer, {
    optionalFeatures: ['dom-overlay', 'local-floor', 'hand-tracking'],
    domOverlay: { root: overlayRoot }
  });
  vrButton.classList.add('vrButton');
  document.getElementById('vrbtnWrap').appendChild(vrButton);

  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();

  // Camera
  const camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.01, 2000);
  camera.position.set(0, 1.6, 3.5);

  // Light
  const hemi = new THREE.HemisphereLight(0x88ffbb, 0x003311, 0.6);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0x66ffcc, 0.5);
  dir.position.set(5,5,5);
  scene.add(dir);

  // Stars background
  const stars = new THREE.Group();
  {
    const g = new THREE.BufferGeometry();
    const COUNT = 2000;
    const positions = new Float32Array(COUNT * 3);
    for(let i=0;i<COUNT;i++){
      const r = 100 + Math.random()*200;
      const phi = Math.random()*Math.PI*2;
      const cost = Math.random()*2-1;
      const sint = Math.sqrt(1 - cost*cost);
      positions[i*3+0] = r * Math.cos(phi) * sint;
      positions[i*3+1] = r * cost;
      positions[i*3+2] = r * Math.sin(phi) * sint;
    }
    g.setAttribute('position', new THREE.BufferAttribute(positions,3));
    const m = new THREE.PointsMaterial({ size: 0.6, sizeAttenuation:true, color:0x00ff66, transparent:true, opacity:0.8 });
    const pts = new THREE.Points(g,m);
    stars.add(pts);
  }
  scene.add(stars);

  // Sun + simple orbits (just for spatial reference)
  const sun = new THREE.Mesh(
    new THREE.SphereGeometry(0.4,32,32),
    new THREE.MeshBasicMaterial({ color:0xffcc66 })
  );
  scene.add(sun);

  function makeOrbit(radius, color=0x005533){
    const curve = new THREE.EllipseCurve(0,0, radius, radius*0.8, 0, Math.PI*2);
    const pts = curve.getSpacedPoints(256).map(p => new THREE.Vector3(p.x, 0, p.y));
    const geo = new THREE.BufferGeometry().setFromPoints(pts);
    const mat = new THREE.LineDashedMaterial({ color, dashSize:1.2, gapSize:0.6, linewidth:1 });
    const line = new THREE.Line(geo, mat);
    line.computeLineDistances();
    return line;
  }
  scene.add(makeOrbit(2.0));
  scene.add(makeOrbit(3.0));
  scene.add(makeOrbit(4.0));

  // Comet placeholders + trails
  const cometMaterials = {
    oumuamua: new THREE.MeshStandardMaterial({ color:0x66ffcc, metalness:.2, roughness:.4, emissive:0x003322, emissiveIntensity:.6 }),
    borisov:   new THREE.MeshStandardMaterial({ color:0x66aaff, metalness:.2, roughness:.5, emissive:0x001133, emissiveIntensity:.6 }),
    atlas:     new THREE.MeshStandardMaterial({ color:0xaaff66, metalness:.2, roughness:.5, emissive:0x113300, emissiveIntensity:.6 })
  };

  function makeComet(name){
    const core = new THREE.Mesh(new THREE.IcosahedronGeometry(0.12,1), cometMaterials[name]);
    core.userData.name = name;

    const trailGeo = new THREE.ConeGeometry(0.06, 0.8, 16, 1, true);
    const trailMat = new THREE.MeshBasicMaterial({ color:0x00ff66, transparent:true, opacity:.3, side:THREE.DoubleSide });
    const trail = new THREE.Mesh(trailGeo, trailMat);
    trail.position.z = -0.35;
    trail.rotation.x = Math.PI;
    core.add(trail);

    return core;
  }
  const cometO = makeComet('oumuamua'); cometO.position.set(2.0, 0.1, 0);
  const cometB = makeComet('borisov');   cometB.position.set(0, 0.1, 3.0);
  const cometA = makeComet('atlas');     cometA.position.set(-3.0, 0.1, 0);

  scene.add(cometO, cometB, cometA);

  // OrbitControls for desktop
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.target.set(0, 0.5, 0);

  // Controller visualization (models) + rays
  const controllerModelFactory = new XRControllerModelFactory();

  const controller1 = renderer.xr.getController(0);
  const controller2 = renderer.xr.getController(1);
  scene.add(controller1, controller2);

  const controllerGrip1 = renderer.xr.getControllerGrip(0);
  controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
  scene.add(controllerGrip1);

  const controllerGrip2 = renderer.xr.getControllerGrip(1);
  controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
  scene.add(controllerGrip2);

  function addRayLine(obj){
    const geo = new THREE.BufferGeometry().setFromPoints([ new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-5) ]);
    const mat = new THREE.LineBasicMaterial({ color:0x00ff66 });
    const line = new THREE.Line(geo, mat);
    line.name = 'ray';
    line.scale.z = 1;
    obj.add(line);
  }
  addRayLine(controller1);
  addRayLine(controller2);

  // Simple pulse animation for comets
  let t = 0;
  function animateComets(dt){
    t += dt;
    [cometO, cometB, cometA].forEach((c, i)=>{
      c.rotation.y += 0.002 + i*0.0005;
      const s = 1 + 0.03*Math.sin(t* (1.2+i*0.7));
      c.scale.setScalar(s);
    });
    // Light orbit motion (elliptical-ish)
    cometO.position.x =  2.0*Math.cos(t*0.2);
    cometO.position.z =  1.6*Math.sin(t*0.2);

    cometB.position.x =  2.6*Math.cos(t*0.16 + 1.1);
    cometB.position.z =  2.0*Math.sin(t*0.16 + 1.1);

    cometA.position.x =  3.2*Math.cos(t*0.12 + 2.2);
    cometA.position.z =  2.6*Math.sin(t*0.12 + 2.2);
  }

  // Camera helpers
  function zoom(delta){
    // Smooth dolly on desktop; in VR, we move the camera parent (viewer) slightly
    if(renderer.xr.isPresenting){
      const s = renderer.xr.getSession();
      // In VR we adjust camera by moving scene objects subtly (safer than moving XR cam directly)
      scene.position.z += (-delta * 0.2);
    } else {
      const dir = new THREE.Vector3();
      camera.getWorldDirection(dir);
      camera.position.addScaledVector(dir, -delta);
    }
  }

  // DOM logic
  const passport = document.getElementById('passport');
  const currentComet = document.getElementById('currentComet');
  const fDesignation = document.getElementById('fDesignation');
  const fDiscovery   = document.getElementById('fDiscovery');
  const fOrigin      = document.getElementById('fOrigin');
  const fNotes       = document.getElementById('fNotes');
  const modeBadge    = document.getElementById('modeBadge');

  const cometData = {
    oumuamua: {
      title: "1I / ʻOumuamua",
      designation: "1I/2017 U1",
      discovery: "2017 — Pan-STARRS",
      origin: "Interstellar (unknown parent system)",
      notes: "Highly elongated body; non-gravitational acceleration debated."
    },
    borisov: {
      title: "2I / Borisov",
      designation: "2I/2019 Q4",
      discovery: "2019 — G. Borisov",
      origin: "Interstellar; classic comet with coma",
      notes: "Typical volatile coma; behaved like a 'normal' comet in many respects."
    },
    atlas: {
      title: "3I / ATLAS",
      designation: "3I/2025 ???",
      discovery: "2025 — ATLAS survey (placeholder)",
      origin: "Interstellar; candidate classification",
      notes: "Active research; spectral lines under study; parameters updating."
    }
  };

  function setComet(name){
    const d = cometData[name];
    if(!d) return;
    currentComet.textContent = d.title;
    fDesignation.textContent = d.designation;
    fDiscovery.textContent   = d.discovery;
    fOrigin.textContent      = d.origin;
    fNotes.textContent       = d.notes;

    // Smooth focus to comet
    const obj = name === 'oumuamua' ? cometO : name === 'borisov' ? cometB : cometA;
    focusOnObject(obj);
  }
  setComet('oumuamua');

  function focusOnObject(obj){
    // Desktop: orbit controls target and smooth camera move
    if(!renderer.xr.isPresenting){
      controls.target.lerp(obj.getWorldPosition(new THREE.Vector3()), 0.6);
      const dir = new THREE.Vector3().subVectors(camera.position, controls.target).setLength(2.5);
      camera.position.copy(controls.target).add(dir);
    } else {
      // VR: gently move the scene so the object sits ~2m ahead
      const wp = obj.getWorldPosition(new THREE.Vector3());
      const targetOffset = new THREE.Vector3(0, 1.5, -2.0);
      // Compute current camera world pos
      const camPos = new THREE.Vector3();
      camera.getWorldPosition(camPos);
      // Desired scene shift = (target point relative to cam) minus current object vector
      const desired = new THREE.Vector3().addVectors(camPos, targetOffset);
      const shift = new THREE.Vector3().subVectors(desired, wp).multiplyScalar(0.3);
      scene.position.add(shift);
    }
  }

  // Buttons
  document.querySelectorAll('[data-comet]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      setComet(e.currentTarget.getAttribute('data-comet'));
    });
  });
  document.getElementById('zoomIn').addEventListener('click', ()=> zoom(0.3));
  document.getElementById('zoomOut').addEventListener('click', ()=> zoom(-0.3));
  document.getElementById('bigMode').addEventListener('click', ()=>{
    passport.classList.toggle('big');
  });

  // VR session events (update badge, ensure controllers visible)
  renderer.xr.addEventListener('sessionstart', ()=>{
    modeBadge.textContent = 'MODE: VR';
    // Ensure ray lines visible
    ['ray'].forEach(n=>{
      const r1 = controller1.getObjectByName(n);
      const r2 = controller2.getObjectByName(n);
      if(r1) r1.visible = true;
      if(r2) r2.visible = true;
    });
  });
  renderer.xr.addEventListener('sessionend', ()=>{
    modeBadge.textContent = 'MODE: DESKTOP';
  });

  // Handle resize
  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Main loop
  const clock = new THREE.Clock();
  renderer.setAnimationLoop(()=>{
    const dt = clock.getDelta();
    animateComets(dt);
    controls.update();
    renderer.render(scene, camera);
  });
</script>
</body>
</html>
