<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>VR HUD — DIAG</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#04060a">
<style>
  html,body{margin:0;height:100%;background:#04060a;color:#aee8ff;font-family:ui-monospace,Consolas,Monaco,monospace}
  #log{position:fixed;left:12px;bottom:12px;z-index:20;max-width:50vw}
  .ok{color:#80ff8a}.warn{color:#ffd166}.err{color:#ff6b6b}
  #ui{position:fixed;left:12px;bottom:64px;z-index:10}
  #ui button{padding:6px 10px;margin-right:8px}
  canvas{display:block}
</style>
</head>
<body>

<div id="ui">
  <button onclick="enterVR()">Enter VR</button>
  <button onclick="location.reload()">Reload</button>
</div>
<div id="log"></div>

<script>
const log = (msg, cls='ok')=>{
  const d=document.createElement('div'); d.className=cls; d.textContent=msg;
  document.getElementById('log').appendChild(d);
  console.log(msg);
};

// 0) Проверка WebGL
(function(){
  const gl = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl');
  if(gl) log('WebGL: OK'); else log('WebGL: НЕТ (включи аппаратное ускорение / отключи строгие блокировщики)', 'err');
})();

// 1) Загружаем A-Frame c jsDelivr, при неудаче — с unpkg
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=()=>res(src);s.onerror=()=>rej(src);document.head.appendChild(s);});}

(async ()=>{
  try{
    log('Пробую загрузить A-Frame с jsDelivr…','warn');
    await loadScript('https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js');
    log('A-Frame с jsDelivr: OK');
  }catch(e){
    log('A-Frame с jsDelivr НЕ загрузился','err');
  }
  if(!window.AFRAME){
    try{
      log('Пробую загрузить A-Frame с unpkg…','warn');
      await loadScript('https://unpkg.com/aframe@1.5.0/dist/aframe.min.js');
      log('A-Frame с unpkg: OK');
    }catch(e){
      log('A-Frame с unpkg НЕ загрузился','err');
    }
  }

  if(window.AFRAME){
    bootAframe();   // пошли по линии A-Frame
  }else{
    log('A-Frame недоступен. Включаю запасной рендер на Three.js…','warn');
    bootThreeFallback();
  }
})();

// 2A) Линия A-Frame: создаём сцену, куб и HUD-панель (прикрепляем к камере)
function bootAframe(){
  log('A-Frame найден: '+AFRAME.version);

  // добавляем сцену в DOM
  const scene = document.createElement('a-scene');
  scene.setAttribute('background','color: #04060a');
  scene.setAttribute('renderer','colorManagement:true; physicallyCorrectLights:false');
  scene.setAttribute('xr','enabled:true');
  document.body.appendChild(scene);

  // риг и камера
  const rig = document.createElement('a-entity');
  rig.setAttribute('id','rig'); rig.setAttribute('position','0 1.6 0');
  const cam = document.createElement('a-entity');
  cam.setAttribute('id','cam'); cam.setAttribute('camera',''); cam.setAttribute('look-controls','pointerLockEnabled:false; mouseEnabled:true');
  rig.appendChild(cam); scene.appendChild(rig);

  // тестовый куб
  const box = document.createElement('a-box');
  box.setAttribute('position','0 1.6 -2'); box.setAttribute('color','#00ff66');
  scene.appendChild(box);

  // свет
  const amb = document.createElement('a-entity');
  amb.setAttribute('light','type:ambient; color:#5fffd0; intensity:0.2');
  scene.appendChild(amb);

  scene.addEventListener('loaded', ()=>{
    log('A-Frame scene loaded');

    // HUD-панель: плоская, как ребёнок камеры
    const panel = document.createElement('a-entity');
    panel.setAttribute('id','hudPanel');
    panel.setAttribute('position','0 0 -1.0');
    panel.setAttribute('rotation','0 0 0');
    panel.setAttribute('hud-texture','width:1024; height:512; metersW:1.6; metersH:0.8');
    cam.appendChild(panel);

    // компонент текстуры
    AFRAME.registerComponent('hud-texture',{
      schema:{ width:{type:'int',default:1024}, height:{type:'int',default:512}, metersW:{type:'number',default:1.6}, metersH:{type:'number',default:0.8} },
      init(){
        const d=this.data, THREE=AFRAME.THREE;
        // локальный холст
        this.canvas=document.createElement('canvas'); this.canvas.width=d.width; this.canvas.height=d.height;
        this.ctx=this.canvas.getContext('2d');
        this.tex=new THREE.CanvasTexture(this.canvas);
        this.mesh=new THREE.Mesh(new THREE.PlaneGeometry(d.metersW,d.metersH), new THREE.MeshBasicMaterial({map:this.tex, side:THREE.DoubleSide}));
        this.el.object3D.add(this.mesh);
        this.t0=performance.now();
        this.draw(0); this.tex.needsUpdate=true; // первый кадр
      },
      draw(t){
        const g=this.ctx, W=this.canvas.width, H=this.canvas.height;
        g.fillStyle='#04060a'; g.fillRect(0,0,W,H);
        g.fillStyle='#00ff66'; g.font='bold 42px ui-monospace,monospace';
        g.fillText('C:\\> HUD ONLINE', 40, 72);
        for(let i=0;i<48;i++){
          const x=40+i*20, bar=(Math.sin((t/600)+i*0.4)*0.5+0.5)*360+20;
          g.fillRect(x, H-40-bar, 12, bar);
        }
        g.fillStyle='#aee8ff'; g.font='20px ui-monospace,monospace';
        g.fillText('AFRAME '+AFRAME.version+'  |  '+new Date().toLocaleTimeString(), 40, H-28);
      },
      tick(t){ this.draw(t); this.tex.needsUpdate=true; }
    });

    log('Готово: должен быть зелёный куб и HUD перед камерой');
  });

  // кнопка Enter VR
  window.enterVR = ()=>{ scene.enterVR(); };
}

// 2B) Линия резервная: Three.js (если A-Frame не загрузился)
async function bootThreeFallback(){
  try{
    await loadScript('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js');
    await loadScript('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js');
  }catch(e){
    log('Three.js тоже не загрузился. Похоже, CDN блокируется. Отключи VPN/AdBlock и обнови.', 'err');
    return;
  }
  log('Three.js загружен: отображаю вращающийся куб','warn');

  const W=innerWidth, H=innerHeight;
  const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(W,H); document.body.appendChild(renderer.domElement);
  const scene=new THREE.Scene(); scene.background=new THREE.Color(0x04060a);
  const camera=new THREE.PerspectiveCamera(70, W/H, 0.01, 50);
  camera.position.set(0,1.6,0);

  const geo=new THREE.BoxGeometry(0.5,0.5,0.5);
  const mat=new THREE.MeshBasicMaterial({color:0x00ff66});
  const cube=new THREE.Mesh(geo,mat); cube.position.set(0,1.6,-2); scene.add(cube);

  function animate(t){ cube.rotation.y=t/1000; renderer.render(scene,camera); requestAnimationFrame(animate); }
  requestAnimationFrame(animate);
}

</script>
</body>
</html>
